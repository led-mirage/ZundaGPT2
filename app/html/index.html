<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ZundaGPT2</title>
<link rel="stylesheet" href="css/style.css">
<script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div class="chat-container">
  <div class="header">
    <span>ZundaGPT</span>
    <nav>
      <ul>
        <li><button onclick="prevChat()">prev</button></li>
        <li><button onclick="nextChat()">next</button></li>
        <li><button onclick="newChat()">new</button></li>
        <li><button onclick="deleteChat()" class="delete">ğŸ—‘ï¸</button></li>
      </ul>
    </nav>
  </div>
  <div id="chat-messages" class="chat-messages">
    <!-- ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹
    <div class="chat-message">
      <div class="speaker-name">ç™ºè¨€è€…A</div>
      <div class="message-text">ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯è‰¯ã„å¤©æ°—ã§ã™ã­ã€‚</div>
    </div>
    -->
  </div>
  <div class="chat-input">
    <textarea id="message" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
    <button type="button" onclick="submit()">é€ä¿¡</button>
  </div>
</div>
<footer>Copyright 2024 led-mirage</footer>

<script>
let g_userName = "ã‚ãªãŸ";
let g_userColor = "#007bff";
let g_assistantName = "ãšã‚“ã ";
let g_assistantColor = "#006400";

// åˆæœŸåŒ–
document.addEventListener("DOMContentLoaded", function() {
    const textarea = document.getElementById("message");
    textarea.addEventListener("input", autoResize, false);
    autoResize.call(textarea);

    function autoResize() {
        this.style.height = "auto";
        this.style.height = this.scrollHeight - rem2px(2) + "px";
    }

    document.getElementById('message').addEventListener('keydown', function(event) {
        // EnterãŒæŠ¼ã•ã‚ŒãŸãŒã€ShiftãŒæŠ¼ã•ã‚Œã¦ã„ãªã„å ´åˆ
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Enterã«ã‚ˆã‚‹æ”¹è¡Œã‚’é˜²ã
            submit(); // é€ä¿¡å‡¦ç†ã‚’å®Ÿè¡Œ
        }
    });
});

// pywebviewã®åˆæœŸåŒ–å®Œäº†
window.addEventListener("pywebviewready", function() {
    pywebview.api.page_loaded();
})

// remã‚’pxã«å¤‰æ›
function rem2px(rem) {
    var rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
    return rem * rootFontSize;
}

// é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
async function submit() {
    const text = document.getElementById("message").value;
    if (text === "") return;

    // HTMLã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    addChatMessage(g_userName, g_userColor, text)
    scrollToBottom();
    document.getElementById("message").value = "";

    // Pythonå´ã«é€šçŸ¥
    try {
        await pywebview.api.send_message_to_chatgpt(text);
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸‹ç«¯ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹
function scrollToBottom() {
    const messageContainer = document.querySelector(".chat-messages");
        messageContainer.scrollTop = messageContainer.scrollHeight;
}

// æ–‡å­—åˆ—ã‚’HTMLç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
function escapeHtml(text) {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#x27;")
        .replace(/\n/g, "<br>")
        .replace(/ /g, "&nbsp;")
        .replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
}

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹
function addChatMessage(speakerName, color, messageText) {
    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
    const chatMessagesContainer = document.getElementById('chat-messages');

    // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
    const chatMessageElement = document.createElement('div');
    chatMessageElement.classList.add('chat-message');

    // ç™ºè¨€è€…åã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ã‚’ä½œæˆ
    const speakerElement = document.createElement('div');
    speakerElement.classList.add('speaker-name');
    speakerElement.style.color = color;
    speakerElement.textContent = speakerName;

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ã‚’ä½œæˆ
    const messageElement = document.createElement('div');
    messageElement.classList.add('message-text');
    messageElement.innerHTML = escapeHtml(messageText);

    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã«ç™ºè¨€è€…åã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆã®è¦ç´ ã‚’è¿½åŠ 
    chatMessageElement.appendChild(speakerElement);
    chatMessageElement.appendChild(messageElement);

    // ä½œæˆã—ãŸãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
    chatMessagesContainer.appendChild(chatMessageElement);
}

// æ–°è¦ãƒãƒ£ãƒƒãƒˆé–‹å§‹
async function newChat() {
    // ãƒãƒ£ãƒƒãƒˆè¦ç´ ã‚’å‰Šé™¤
    document.getElementById('chat-messages').innerHTML = "";

    // Pythonå´ã«é€šçŸ¥
    try {
        await pywebview.api.new_chat();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ã²ã¨ã¤å‰ã®ãƒãƒ£ãƒƒãƒˆã«ç§»å‹•ã™ã‚‹
async function prevChat() {
    try {
        await pywebview.api.prev_chat();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ã²ã¨ã¤å¾Œã®ãƒãƒ£ãƒƒãƒˆã«ç§»å‹•ã™ã‚‹
async function nextChat() {
    try {
        await pywebview.api.next_chat();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤ã™ã‚‹
async function deleteChat() {
    const messageTextElements = document.querySelectorAll('#chat-messages .message-text');
    if (messageTextElements.length === 0) return;

    if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

    try {
        await pywebview.api.delete_current_chat();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// æƒ…å ±ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
function setChatInfo(userName, userColor, assistantName, assistantColor) {
    g_userName = userName;
    g_userColor = userColor;
    g_assistantName = assistantName;
    g_assistantColor = assistantColor;
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// AIã‹ã‚‰ã®ãƒãƒ£ãƒƒãƒˆå¿œç­”ã‚’é–‹å§‹ã™ã‚‹
function startResponse() {
    addChatMessage(g_assistantName, g_assistantColor, "");

    const nameTextElements = document.querySelectorAll('#chat-messages .speaker-name');
    const lastNameTextElements = nameTextElements[nameTextElements.length - 1];
    if(lastNameTextElements) {
        lastNameTextElements.classList.add('flowing-text');
    }
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// AIã‹ã‚‰ã®å¿œç­”ï¼ˆãƒãƒ£ãƒ³ã‚¯ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹
function addChunk(text) {
    const messageTextElements = document.querySelectorAll('#chat-messages .message-text');
    const lastMessageTextElement = messageTextElements[messageTextElements.length - 1];
    if(lastMessageTextElement) {
        lastMessageTextElement.innerHTML += escapeHtml(text);
        scrollToBottom();
    }
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ã®èª­ã¿ä¸Šã’ãŒçµ‚ã‚ã£ãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹
function parsedSentence() {
    MathJax.typesetPromise();
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// AIã‹ã‚‰ã®ãƒãƒ£ãƒƒãƒˆå¿œç­”ãŒçµ‚äº†ã—ãŸ
function endResponse() {
    const nameTextElements = document.querySelectorAll('#chat-messages .speaker-name');
    const lastNameTextElements = nameTextElements[nameTextElements.length - 1];
    if(lastNameTextElements) {
        lastNameTextElements.classList.remove('flowing-text');
    }
    MathJax.typesetPromise();
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ãƒãƒ£ãƒƒãƒˆå¿œç­”ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã—ãŸ
function handleChatTimeout() {
    alert("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã®ã ")
    endResponse()
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ãƒãƒ£ãƒƒãƒˆå¿œç­”ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸ
function handleChatException() {
    alert("ãªã‚“ã‹ã‚ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã®ã ")
    endResponse()
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ãƒãƒ£ãƒƒãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†è¨­å®šã™ã‚‹
function setChatMessages(messages) {
    console.log(messages);
    document.getElementById("chat-messages").innerHTML = "";
    for (let message of messages) {
        let speakerName = "";
        let speakerColor = "";
        if (message.role === "assistant") {
            speakerName = g_assistantName;
            speakerColor = g_assistantColor;
        }
        else {
            speakerName = g_userName;
            speakerColor = g_userColor;
        }
        addChatMessage(speakerName, speakerColor, message.content);
    }
    MathJax.typesetPromise();
    scrollToBottom();
}
</script>

</body>
</html>
