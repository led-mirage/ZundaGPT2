<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ZundaGPT2</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js" integrity="sha512-tjg8I2d6Fi0OBGz1csmr7RfI4uupYaCfL/RqhVRTS42RMGwfBsjwBGmhzhI+e2dPmyew8cFkoxnVkGvADDLvbg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<link rel="stylesheet" href="css/style.css">
<script>
MathJax = {
    tex: {
        inlineMath: [["$", "$"], ["\\(", "\\)"]]
    },
    svg: {
        fontCache: "global"
    },
    chtml: {
        displayAlign: "left"
    },
    options: {
        skipHtmlTags: ["script", "noscript", "style", "textarea", "pre", "code"],
        ignoreHtmlClass: "mathjax_ignore",
    }
};
marked.setOptions(
    {
        breaks: true
    }
);
</script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
<script src="js/textResources.js" defer></script>
</head>
<body>
<div class="chat-container">
  <div class="header">
    <span id="settings-name">ZundaGPT</span>
    <nav>
      <ul>
        <li><button id="prev-button" onclick="prevChat()" class="tooltip"><i class="fa-solid fa-backward-step"></i><span class="tooltiptext">å‰ã®ä¼šè©±</span></button></li>
        <li><button id="next-button" onclick="nextChat()" class="tooltip"><i class="fa-solid fa-forward-step"></i><span class="tooltiptext">æ¬¡ã®ä¼šè©±</span></button></li>
        <li><button id="new-button" onclick="newChat()" class="tooltip"><i class="fa-solid fa-plus"></i><span class="tooltiptext">æ–°ã—ã„ä¼šè©±</span></button></li>
        <li style="width: 1.25rem;"></li>
        <li><button id="cross-search-button" onclick="crossFileSearch()" class="tooltip"><i class="fa fa-search"></i><span class="tooltiptext">ãƒ•ã‚¡ã‚¤ãƒ«æ¨ªæ–­æ¤œç´¢</span></button></li>
        <li><button id="delete-button" onclick="deleteChat()" class="tooltip"><i class="fa-regular fa-trash-can"></i><span class="tooltiptext">å‰Šé™¤</span></button></li>
        <li><button id="speaker-button" onclick="toggleSpeaker()" class="tooltip" id="speaker-button"><i class="fa-solid fa-volume-high"></i><span class="tooltiptext">éŸ³å£°</span></button></li>
        <li><button id="print-button" onclick="print()" class="tooltip"><i class="fa-solid fa-print"></i><span class="tooltiptext">å°åˆ·</span></button></li>
        <li><button id="settings-button" onclick="settings()" class="tooltip"><i class="fa-solid fa-gear"></i><span class="tooltiptext">è¨­å®š</span></button></li>
      </ul>
    </nav>
  </div>
  <div id="chat-messages" class="chat-messages">
    <!-- ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹
    <div class="chat-message" id="message-0">
      <div class="speaker-name">ç™ºè¨€è€…A<button class="message-delete-btn">ğŸ—‘ï¸</button></div>
      <div class="message-text">ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯è‰¯ã„å¤©æ°—ã§ã™ã­ã€‚</div>
    </div>
    -->
  </div>
  <div class="chat-input">
    <textarea id="message" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
    <button id="submit-button" type="button" onclick="submit()">é€ä¿¡</button>
  </div>
  <footer><span id="copyright">Copyright</span></footer>
</div>
<!-- é€²æ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="progress-modal" class="modal">
    <div class="modal-content">
        <div class="loader"></div>
        <p id="progress-modal-message"></p>
    </div>
</div>
<!-- è¦ç´„è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="summary-modal" class="summary-modal">
    <div class="summary-modal-content">
        <div class="summary-modal-header">
            <span id="summary-modal-close-button" class="close">&times;</span>
        </div>
        <div class="summary-modal-body">
            <p id="summary-modal-content"></p>
        </div>
    </div>
</div>

<script>
let g_userName = "ã‚ãªãŸ";
let g_userColor = "#007bff";
let g_userIcon = "";
let g_assistantName = "ãšã‚“ã ";
let g_assistantColor = "#006400";
let g_assistantIcon = "";
let g_speakerOn = true;
let g_nextMessageIndex = 0;
let g_searchTextIndex = 0;
let g_searchTextTotal = 0;
let g_welcomeTitle = "";
let g_welcomeMessage = "";
let g_aiAgentAvailable = false;
let g_aiAgentCreationError = "";

// åˆæœŸåŒ–
document.addEventListener("DOMContentLoaded", function() {
    const textarea = document.getElementById("message");
    textarea.addEventListener("input", autoResize, false);

    const button = document.getElementById("submit-button");
    button.addEventListener("click", function(){
        autoResize.call(textarea);
    }, false);

    document.getElementById("message").addEventListener("keydown", function(event) {
        // EnterãŒæŠ¼ã•ã‚ŒãŸãŒã€ShiftãŒæŠ¼ã•ã‚Œã¦ã„ãªã„å ´åˆ
        if (event.key === "Enter" && !event.shiftKey) {
            const button = document.getElementById("submit-button");
            if (button) {
                if (!button.classList.contains("submit-button-disabled")) {
                    event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Enterã«ã‚ˆã‚‹æ”¹è¡Œã‚’é˜²ã
                    submit(); // é€ä¿¡å‡¦ç†ã‚’å®Ÿè¡Œ
                    autoResize.call(textarea);
                }
            }
        }
    });

    // ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®ç™»éŒ²
    document.addEventListener("keydown", handleKeyDown);

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®ç™»éŒ²
    document.addEventListener("contextmenu", handleContextMenu);

    autoResize.call(textarea);

    function autoResize() {
        this.style.height = "auto";
        this.style.height = this.scrollHeight - rem2px(2) + "px";
    }
});

// ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
function handleKeyDown(event) {
    if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.keyCode === 70) { // Ctrl + Shift + F
        crossFileSearch();
    }
    else if ((event.ctrlKey || event.metaKey) && event.keyCode === 70) { // Ctrl + F
        searchText();
    }
    else if ((event.ctrlKey || event.metaKey) && event.keyCode === 82) { // Ctrl + R
        let result = confirm(getTextResource("replayConfirm"));
        if (result) {
            document.getElementById("chat-messages").innerHTML = "";
            pywebview.api.replay();
        }
    }
    else if (event.keyCode == 27) { // ESC
        var instance = new Mark(document.body);
        g_searchTextIndex = g_searchTextTotal = 0;
        instance.unmark();
    }
    else if (event.keyCode == 114) { // F3
        if (g_searchTextTotal > 0) {
            if (event.shiftKey) {
                g_searchTextIndex--;
                if (g_searchTextIndex < 0) {
                    g_searchTextIndex = g_searchTextTotal - 1;
                }
            }
            else {
                g_searchTextIndex++;
                if (g_searchTextIndex >= g_searchTextTotal) {
                    g_searchTextIndex = 0;
                }
            }
            highlightSearchResult();
        }
    }
}

// ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
function handleContextMenu(event) {
    event.preventDefault();

    // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Œã°æ¶ˆã™
    const existingMenu = document.querySelector('.contextmenu');
    if (existingMenu) {
        document.body.removeChild(existingMenu);
    }

    let menuContent = "";
    menuContent += `<button id="copy"><i class="fa-regular fa-copy"></i> ${getTextResource("copyContextMenu")}</button><br>`;
    menuContent += `<button id="search"><i class="fa-solid fa-magnifying-glass"></i> ${getTextResource("searchContextMenu")}</button><br>`;
    menuContent += `<button id="summary"><i class="fa-solid fa-compress"></i> ${getTextResource("summaryContextMenu")}</button><br>`;

    const menu = document.createElement("div");
    menu.className = "contextmenu";
    menu.style.visibility = "hidden";
    menu.innerHTML = menuContent;
    document.body.appendChild(menu);
    const menuWidth = menu.offsetWidth;
    const menuHeight = menu.offsetHeight;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    let xPos = event.pageX;
    let yPos = event.pageY;
    if (xPos + menuWidth > windowWidth) {
        xPos = windowWidth - menuWidth - 10;
    } 
    if (yPos + menuHeight > windowHeight) {
        yPos = windowHeight - menuHeight - 10;
    }
    menu.style.left = `${xPos}px`;
    menu.style.top = `${yPos}px`;
    menu.style.visibility = "visible";

    const copyButton = document.getElementById("copy");
    if (copyButton) {
        copyButton.addEventListener("click", function(clickEvent) {
            const selectedText = window.getSelection().toString();
            if (selectedText) {
                document.body.removeChild(menu);
                navigator.clipboard.writeText(selectedText);
                showToast(clickEvent, getTextResource("textCopiedMessage"));
            }
            else {
                copyChatAllMessages();
                showToast(clickEvent, getTextResource("allMessageCopiedMessage"));
            }
        });
    }

    const searchButton = document.getElementById("search");
    if (searchButton) {
        searchButton.addEventListener("click", function() {
            document.body.removeChild(menu);
            // å°‘ã—ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’é…ã‚‰ã›ãªã„ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒæ¶ˆãˆãªã„
            setTimeout(function() {
                const selectedText = window.getSelection().toString();
                searchText(selectedText);
            }, 100);
        });
    }

    const summaryButton = document.getElementById("summary");
    if (summaryButton) {
        summaryButton.addEventListener("click", function(clickEvent) {
            document.body.removeChild(menu);
            // å°‘ã—ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’é…ã‚‰ã›ãªã„ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒæ¶ˆãˆãªã„
            setTimeout(function() {
                summarizeChat(clickEvent);
            }, 100);
        });
    }

    // ã©ã“ã‹ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ¶ˆã™
    document.addEventListener("click", function() {
        if (document.body.contains(menu)) {
            document.body.removeChild(menu);
        }
    }, { once: true });
}

// pywebviewã®åˆæœŸåŒ–å®Œäº†
window.addEventListener("pywebviewready", async function() {
    try {
        copyright = await pywebview.api.get_copyright();
        footer = document.getElementById("copyright");
        if (footer) {
            footer.textContent = copyright;
        }

        await pywebview.api.page_loaded();

        if (document.querySelectorAll(".chat-message").length === 0) {
            addWelcome();
        }
    }
    catch (error) {
        console.error("Error: " + error)
    }
})

// remã‚’pxã«å¤‰æ›
function rem2px(rem) {
    var rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
    return rem * rootFontSize;
}

// IMEå¯¾ç­–
// IMEãŒONã®çŠ¶æ…‹ã‹ã¤ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚ã‚‹çŠ¶æ…‹ã§ã€
// åˆ¥ã®ã‚¢ãƒ—ãƒªã‚’è¦‹ã‚‹ãªã©ã—ã¦ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤±ã‚ã‚Œå†åº¦æˆ»ã£ã¦ããŸã¨ãã«ã€
// IMEã®å¤‰æ›ãŒãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹å†…ã§ã§ããªããªã‚‹ç¾è±¡ã«å¯¾å‡¦
window.onfocus = function() {
    document.getElementById("message").blur();
}

// UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆæœŸåŒ–
function initUIComponents(language) {
    setCurrentLanguage(language);

    let button = document.getElementById("submit-button");
    if (button) {
        button.textContent = getTextResource("submitButton");
    }

    button = document.getElementById("prev-button");
    if (button) {
        const tooltip = button.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.textContent = getTextResource("prevButtonTooltip");
        }
    }

    button = document.getElementById("next-button");
    if (button) {
        const tooltip = button.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.textContent = getTextResource("nextButtonTooltip");
        }
    }

    button = document.getElementById("new-button");
    if (button) {
        const tooltip = button.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.textContent = getTextResource("newButtonTooltip");
        }
    }

    button = document.getElementById("cross-search-button");
    if (button) {
        const tooltip = button.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.textContent = getTextResource("crossSearchButtonTooltip");
        }
    }

    button = document.getElementById("delete-button");
    if (button) {
        const tooltip = button.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.textContent = getTextResource("deleteButtonTooltip");
        }
    }

    button = document.getElementById("speaker-button");
    if (button) {
        const tooltip = button.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.textContent = getTextResource("speakerOnButtonTooltip");
        }
    }

    button = document.getElementById("print-button");
    if (button) {
        const tooltip = button.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.textContent = getTextResource("printButtonTooltip");
        }
    }

    button = document.getElementById("settings-button");
    if (button) {
        const tooltip = button.querySelector('.tooltiptext');
        if (tooltip) {
            tooltip.textContent = getTextResource("settingsButtonTooltip");
        }
    }

    let textarea = document.getElementById("message");
    if (textarea) {
        textarea.placeholder = getTextResource("messagePlaceholder");
    }
}

// é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
function submit() {
    const button = document.getElementById("submit-button");
    if (button) {
        if (!button.classList.contains("submit-button-disabled")) {
            sendMessage();
        }
        else {
            stopSendMessage();
        }
    }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
async function sendMessage() {
    if (!g_aiAgentAvailable) {
        alert(g_aiAgentCreationError);
        return;
    }

    const text = document.getElementById("message").value;
    if (text === "") return;

    setSubmitButtonState(true);

    // HTMLã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    addChatMessage("user", g_userName, g_userColor, text)
    scrollToBottom();
    hideChatRetryButton();
    document.getElementById("message").value = "";

    // Pythonå´ã«é€šçŸ¥
    try {
        await pywebview.api.send_message_to_chatgpt(text);
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã‚’ä¸­æ­¢ã™ã‚‹
async function stopSendMessage() {
    // Pythonå´ã«é€šçŸ¥
    try {
        await pywebview.api.stop_send_message_to_chatgpt();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// é€ä¿¡ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’è¨­å®šã™ã‚‹
function setSubmitButtonState(isSending) {
    const button = document.getElementById("submit-button");
    if (button) {
        if (isSending) {
            button.textContent = getTextResource("stopButton");
            button.classList.add("submit-button-disabled")
        }
        else {
            button.textContent = getTextResource("submitButton");
            button.classList.remove("submit-button-disabled")
        }
    }
}

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸‹ç«¯ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹
function scrollToBottom() {
    const messageContainer = document.querySelector(".chat-messages");
    messageContainer.scrollTop = messageContainer.scrollHeight;
}

// æ–‡å­—åˆ—ã‚’HTMLç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
function escapeHtml(text) {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#x27;")
        .replace(/\n/g, "<br>")
        .replace(/ /g, "&nbsp;")
        .replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
}

// TeXç”¨ã®æ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
function escapeTex(text) {
    return text.replace(/\\/g, "@@@@");
}

// TeXç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ãŸæ–‡å­—åˆ—ã‚’å…ƒã«æˆ»ã™
function unescapeTex(text) {
    return text.replace(/@@@@/g, "\\");
}

// ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã®ON/OFF
async function toggleSpeaker() {
    g_speakerOn = !g_speakerOn;
    setSpeakerStateText();

    // Pythonå´ã«é€šçŸ¥
    try {
        await pywebview.api.toggle_speaker();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã®çŠ¶æ…‹è¡¨ç¤º
function setSpeakerStateText() {
    let button = document.getElementById("speaker-button");
    if (g_speakerOn) {
        tooltipText = getTextResource("speakerOnButtonTooltip");
        button.innerHTML = `<i class='fa-solid fa-volume-high'></i><span class='tooltiptext'>${tooltipText}</span>`;
    }
    else {
        tooltipText = getTextResource("speakerOffButtonTooltip");
        button.innerHTML = `<i class='fa-solid fa-volume-xmark'></i><span class='tooltiptext'>${tooltipText}</span>`;
    }
}

// Welcomeãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºã‚’ON/OFFã™ã‚‹
function showWelcome(show) {
    const welcome = document.getElementById("welcome");
    if (welcome) {
        if (show) {
            welcome.style.display = "flex";
        }
        else {
            welcome.style.display = "none";
        }
    }
}

// Welcomeãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹
function addWelcome() {
    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
    const chatMessagesContainer = document.getElementById("chat-messages");

    // Welcomeã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
    const welcomeConainer = document.createElement("div");
    welcomeConainer.id = "welcome"
    welcomeConainer.classList.add("welcome");
    chatMessagesContainer.appendChild(welcomeConainer);

    // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ
    if (g_assistantIcon != "") {
        const imgElement = document.createElement("img");
        imgElement.classList.add("welcome-chat-icon");
        imgElement.src = `data:image/png;base64,${g_assistantIcon}`;
        welcomeConainer.appendChild(imgElement);
    }

    // Welcomeã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½œæˆ
    const welcomeTitle = document.createElement("div");
    welcomeTitle.id = "welcome-title"
    welcomeTitle.classList.add("welcome-title");
    welcomeTitle.textContent = g_welcomeTitle;
    welcomeConainer.appendChild(welcomeTitle);

    // Welcomeãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    const welcomeMessage = document.createElement("div");
    welcomeMessage.id = "welcome-message";
    welcomeMessage.classList.add("welcome-message");
    welcomeMessage.textContent = g_welcomeMessage;
    welcomeConainer.appendChild(welcomeMessage);
}

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹
function addChatMessage(role, speakerName, color, messageText) {
    // Welcomeãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®éè¡¨ç¤º
    showWelcome(false);

    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
    const chatMessagesContainer = document.getElementById("chat-messages");

    // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
    const chatMessageElement = document.createElement("div");
    chatMessageElement.classList.add("chat-message");
    chatMessageElement.id = "message-" + g_nextMessageIndex++;

    // ç™ºè¨€è€…åã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ã‚’ä½œæˆ
    const speakerElement = document.createElement("div");
    speakerElement.classList.add("speaker-name");
    speakerElement.style.color = color;
    speakerElement.textContent = speakerName;

    if (role === "user" || role === "replay_user") {
        if (g_userIcon != "") {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã¤ã‘ã‚‹
            const imgElement = document.createElement("img");
            imgElement.classList.add("chat-icon");
            imgElement.src = `data:image/png;base64,${g_userIcon}`;
            speakerElement.prepend(imgElement);
        }
    }
    else if (role === "assistant" || role === "replay_assistant") {
        if (g_assistantIcon != "") {
            // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ã¤ã‘ã‚‹
            const imgElement = document.createElement("img");
            imgElement.classList.add("chat-icon");
            imgElement.src = `data:image/png;base64,${g_assistantIcon}`;
            speakerElement.prepend(imgElement);
        }
    }

    // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’ã¤ã‘ã‚‹
    const copyElement = document.createElement("button");
    copyElement.classList.add("message-copy-btn");
    copyElement.innerHTML = "<i class='fa-regular fa-copy'></i>";
    copyElement.addEventListener("click", copyChatMessage);
    speakerElement.appendChild(copyElement);

    if (role === "user") {
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ã¤ã‘ã‚‹
        const deleteElement = document.createElement("button");
        deleteElement.classList.add("message-delete-btn");
        deleteElement.innerHTML = "<i class='fa-regular fa-trash-can'></i>";
        deleteElement.addEventListener("click", deleteChatMessage);
        speakerElement.appendChild(deleteElement);
    }
    else {
        // å†å›ç­”ãƒœã‚¿ãƒ³ã‚’ã¤ã‘ã‚‹
        if (g_aiAgentAvailable) {
            const retryElement = document.createElement("button");
            retryElement.classList.add("chat-reanswer-btn");
            retryElement.innerHTML = "<i class='fa-solid fa-rotate'></i>";
            retryElement.style.display = "none";
            retryElement.addEventListener("click", reAnswerChat);
            speakerElement.appendChild(retryElement);
        }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ã‚’ä½œæˆ
    const messageElement = document.createElement("div");
    messageElement.classList.add("message-text");
    if (role === "assistant") {
        let html = convertTextToHtmlWithMarkdown(messageText);
        html = escapeTex(html);
        html = adjustURL(html);
        html = marked.parse(html);
        html = unescapeTex(html);
        messageElement.innerHTML = html;
        messageElement.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
        });
        addTargetBlank(messageElement);
    }
    else {
        messageElement.classList.add("mathjax_ignore");
        messageElement.innerHTML = escapeHtml(messageText);
    }

    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚³ãƒ”ãƒ¼ç”¨ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    addCopyToClipboardButton(messageElement);

    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã«ç™ºè¨€è€…åã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆã®è¦ç´ ã‚’è¿½åŠ 
    chatMessageElement.appendChild(speakerElement);
    chatMessageElement.appendChild(messageElement);

    // ä½œæˆã—ãŸãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
    chatMessagesContainer.appendChild(chatMessageElement);
}

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚³ãƒ”ãƒ¼ç”¨ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹
function addCopyToClipboardButton(element) {
    element.querySelectorAll("pre").forEach((block) => {
        const button = document.createElement("button");
        button.innerHTML = "<i class='fa-regular fa-copy'></i>";
        button.className = "copy-button";

        const toast = document.createElement("div");
        toast.className = "code-toast";
        toast.textContent = getTextResource("textCopiedMessage");
        button.appendChild(toast);

        button.addEventListener("click", async () => {
            const code = block.querySelector("code");
            await navigator.clipboard.writeText(code.textContent)
            showToast(toast);
        });

        block.appendChild(button);
    });    
}

// ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ãŸã¨ãã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
function showToast(toast) {
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2000);
}

// ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¿è­·ã—ãªãŒã‚‰HTMLå¤‰æ›ã™ã‚‹é–¢æ•°
function convertTextToHtmlWithMarkdown(text) {
    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸€æ™‚ä¿å­˜
    let codeBlocks = [];
    text = text.replace(/```[\s\S]*?```/g, match => {
        codeBlocks.push(match);
        return `__CODE_BLOCK_${codeBlocks.length-1}__`;
    });

    // ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆæ–‡å­—ã‚’å¤‰æ›
    text = text.replace(/\\`/g, '\\\''); 

    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æˆ»ã™
    codeBlocks.forEach((block, i) => {
        text = text.replace(`__CODE_BLOCK_${i}__`, block);
    });

    return text;
}

// markedãŒãƒªãƒ³ã‚¯ã«é€£ç¶šã™ã‚‹æ–‡å­—åˆ—å…¨ä½“ã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›ã—ã¦ã—ã¾ã†å•é¡Œã«å¯¾å‡¦
function adjustURL(text) {
    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸€æ™‚ä¿å­˜
    let codeBlocks = [];
    text = text.replace(/```[\s\S]*?```/g, match => {
        codeBlocks.push(match);
        return `__CODE_BLOCK_${codeBlocks.length-1}__`;
    });

    // https://ã¾ãŸã¯http://ã§ã¯å§‹ã¾ã‚‰ãªã„ã€www.ã§å§‹ã¾ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³åã®å‰å¾Œã«ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã‚’å…¥ã‚Œã‚‹
    text = text.replace(/(?<!https?:\/\/)(www\.[\w.]+)/g, " `$1` ");
    // https://ã¾ãŸã¯http://ã§å§‹ã¾ã‚‹URLã®å‰å¾Œã«åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã„ã‚Œã‚‹
    text = text.replace(/(https?:\/\/[\w.?=&%+#\/\-]+)/g, ' $1 ');

    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æˆ»ã™
    codeBlocks.forEach((block, i) => {
        text = text.replace(`__CODE_BLOCK_${i}__`, block);
    });

    return text;
}

// è¦ç´ ä¸­ã®<a>ã‚¿ã‚°ã«target="_blank"ã‚’è¨­å®šã™ã‚‹
function addTargetBlank(targetElement) {
    const links = targetElement.getElementsByTagName("a");
    for (let i = 0; i < links.length; i++) {
        if (!links[i].hasAttribute("target")) {
            links[i].setAttribute("target", "_blank");
            links[i].setAttribute("title", links[i].getAttribute("href"));
        }
    }
}

// æ–°è¦ãƒãƒ£ãƒƒãƒˆé–‹å§‹
async function newChat() {
    // ãƒãƒ£ãƒƒãƒˆè¦ç´ ã‚’å‰Šé™¤
    document.getElementById("chat-messages").innerHTML = "";

    // Pythonå´ã«é€šçŸ¥
    try {
        await pywebview.api.new_chat();
        addWelcome();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ã²ã¨ã¤å‰ã®ãƒãƒ£ãƒƒãƒˆã«ç§»å‹•ã™ã‚‹
async function prevChat() {
    try {
        await pywebview.api.prev_chat();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ã²ã¨ã¤å¾Œã®ãƒãƒ£ãƒƒãƒˆã«ç§»å‹•ã™ã‚‹
async function nextChat() {
    try {
        await pywebview.api.next_chat();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤ã™ã‚‹
async function deleteChat() {
    const messageTextElements = document.querySelectorAll("#chat-messages .message-text");
    if (messageTextElements.length === 0) return;

    if (!confirm(getTextResource("deleteConfirm"))) return;

    try {
        await pywebview.api.delete_current_chat();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// è¨­å®šãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸ
async function settings() {
    try {
        await pywebview.api.move_to_settings();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œç´¢ã™ã‚‹
function searchText(query = "") {
    const searchText = prompt(getTextResource("searchPrompt"), query);
    if (searchText) {
        g_searchTextIndex = 0;
        index = 0;
        var instance = new Mark(document.body);
        instance.unmark();
        instance.mark(searchText, {
            each: function(element) {
                // ã“ã®ä¸­ã®å‡¦ç†ã¯ã€è¦‹ã¤ã‹ã£ãŸå„æ¤œç´¢çµæœã«å¯¾ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹
            },
            done: function(totalMarks) {
                // æ¤œç´¢ãŒå®Œäº†ã—ãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†
                g_searchTextTotal = totalMarks;
                highlightSearchResult(250);
            }
        });
    }
}

// ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ã§è¦‹ã¤ã‹ã£ãŸãƒ†ã‚­ã‚¹ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ã‚’è¡Œã†
function highlightSearchResult(delay=0) {
    document.querySelectorAll("mark").forEach((element, index) => {
        if (index === g_searchTextIndex) {
            element.style.color = "red";
            element.style.backgroundColor = ""
            element.scrollIntoView({ behavior: "smooth" });
            setTimeout(() => {
                element.scrollIntoView({ behavior: "smooth" });
            }, delay);
        }
        else {
            element.style.color = "";
            element.style.backgroundColor = "khaki"
        }
    });    
}

// ãƒ•ã‚¡ã‚¤ãƒ«æ¨ªæ–­æ¤œç´¢æ©Ÿèƒ½ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
async function crossFileSearch() {
    try {
        await pywebview.api.move_to_cross_file_search();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸ
async function deleteChatMessage(event) {
    if (!confirm(getTextResource("deleteFromHereConfirm"))) return;

    hideChatRetryButton();

    let messageDiv = event.target.closest(".chat-message");
    let messageId = messageDiv.id;
    let messageIndex = parseInt(messageId.split("-")[1], 10);

    try {
        await pywebview.api.trancate_messages(messageIndex);
        g_nextMessageIndex = messageIndex;
        while (messageDiv.nextSibling) {
            messageDiv.nextSibling.remove();
        }
        messageDiv.remove();
    }
    catch (error) {
        console.error("Error: " + error)
    }

    showChatRetryButton();
}

// ãƒãƒ£ãƒƒãƒˆã®å†å›ç­”ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸ
async function reAnswerChat(event) {
    setSubmitButtonState(true);
    let messageDiv = event.target.closest(".chat-message");
    let messageId = messageDiv.id;
    let messageIndex = parseInt(messageId.split("-")[1], 10);
    messageDiv.remove();

    try {
        g_nextMessageIndex = messageIndex;
        await pywebview.api.ask_another_reply_to_chatgpt(messageIndex);
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ãƒãƒ£ãƒƒãƒˆã®å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚³ãƒ”ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
async function copyChatAllMessages() {
    try {
        const chatText = await pywebview.api.get_all_message_text();
        navigator.clipboard.writeText(chatText);
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸ
async function copyChatMessage(event) {
    const button = event.currentTarget;

    let messageDiv = event.target.closest(".chat-message");
    let messageId = messageDiv.id;
    let messageIndex = parseInt(messageId.split("-")[1], 10);

    try {
        messageText = await pywebview.api.get_message_text(messageIndex);
        await navigator.clipboard.writeText(messageText);
        showToast(event, getTextResource("messageCopiedMessage"));
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ãƒãƒ£ãƒƒãƒˆã‚’è¦ç´„ã™ã‚‹
async function summarizeChat(event) {
    try {
        showProgressModal(getTextResource("summarizingProgressMessage"));
        summary = await pywebview.api.summarize_chat();
        hideProgressModal();

        if (summary) {
            await navigator.clipboard.writeText(summary);
            showToast(event, getTextResource("summaryCopiedMessage"), ToastPosition.CenterScreen);
            showSummaryModal(summary);
        }
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
function showSummaryModal(summary) {
    const modal = document.getElementById("summary-modal");
    const content = document.getElementById("summary-modal-content");
    const closeButton = document.getElementById("summary-modal-close-button");

    if (modal && content && closeButton) {
        content.innerHTML = marked.parse(summary);
        closeButton.addEventListener("click", function() {
            hideSummaryModal();
        });
        modal.style.display = "block";
    }
}

// è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
function hideSummaryModal() {
    const modal = document.getElementById("summary-modal");
    if (modal) {
        modal.style.display = "none";
    }
}

// ãƒˆãƒ¼ã‚¹ãƒˆã®è¡¨ç¤ºä½ç½®
const ToastPosition = {
    ClickPos: "click-pos",
    CenterScreen: "center-screen"
};

// ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
function showToast(event, message, position = ToastPosition.ClickPos, duration = 2000) {
    // ãƒˆãƒ¼ã‚¹ãƒˆè¦ç´ ã‚’ä½œæˆ
    const toast = document.createElement("div");
    toast.classList.add("toast");
    toast.textContent = message;

    // ãƒˆãƒ¼ã‚¹ãƒˆã‚’bodyã«è¿½åŠ 
    document.body.appendChild(toast);
    
    if (position === ToastPosition.ClickPos) {
        // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã®å³å´ã«é…ç½®
        toast.style.left = `${Math.min(window.innerWidth - toast.offsetWidth, event.pageX + 16)}px`;
        toast.style.top = `${Math.min(window.innerHeight - toast.offsetHeight, event.pageY)}px`;
    }
    else {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”»é¢ä¸­å¤®ã«é…ç½®
        toast.style.left = `${(window.innerWidth - toast.offsetWidth) / 2}px`;
        toast.style.top = `${(window.innerHeight - toast.offsetHeight) / 2}px`;
    }
    
    // 2ç§’å¾Œã«æ¶ˆãˆã‚‹
    setTimeout(() => {
        toast.remove();
    }, duration);        
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// æƒ…å ±ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
function setChatInfo(
    displayName, userName, userColor, userIcon,
    assistantName, assistantColor, assistantIcon,
    speakerOn, welcomeTitle, welcomeMessage,
    aiAgentAvailable, aiAgentCreationError
) {
    g_userName = userName;
    g_userColor = userColor;
    g_userIcon = userIcon;
    g_assistantName = assistantName;
    g_assistantColor = assistantColor;
    g_assistantIcon = assistantIcon;
    g_speakerOn = speakerOn;
    g_nextMessageIndex = 0;
    g_welcomeTitle = welcomeTitle;
    g_welcomeMessage = welcomeMessage;
    g_aiAgentAvailable = aiAgentAvailable;
    g_aiAgentCreationError = aiAgentCreationError;

    if (displayName === "") {
        displayName = assistantName;
    }
    document.getElementById("settings-name").textContent = displayName;

    setSpeakerStateText();
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// AIã‹ã‚‰ã®ãƒãƒ£ãƒƒãƒˆå¿œç­”ã‚’é–‹å§‹ã™ã‚‹
function startResponse() {
    addChatMessage("assistant", g_assistantName, g_assistantColor, "");
    scrollToBottom();

    const nameTextElements = document.querySelectorAll("#chat-messages .speaker-name");
    const lastNameTextElements = nameTextElements[nameTextElements.length - 1];
    if(lastNameTextElements) {
        lastNameTextElements.classList.add("flowing-text");
    }
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// AIã‹ã‚‰ã®å¿œç­”ï¼ˆãƒãƒ£ãƒ³ã‚¯ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹
function addChunk(text) {
    const messageTextElements = document.querySelectorAll("#chat-messages .message-text");
    const lastMessageTextElement = messageTextElements[messageTextElements.length - 1];
    if(lastMessageTextElement) {
        lastMessageTextElement.innerHTML += escapeHtml(text);
        scrollToBottom();
    }
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ã®èª­ã¿ä¸Šã’ãŒçµ‚ã‚ã£ãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹
function parsedSentence(sentence) {
    //MathJax.typesetPromise();
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// AIã‹ã‚‰ã®ãƒãƒ£ãƒƒãƒˆå¿œç­”ãŒçµ‚äº†ã—ãŸ
function endResponse(content) {
    setSubmitButtonState(false);
    showChatRetryButton();

    const nameTextElements = document.querySelectorAll("#chat-messages .speaker-name");
    const lastNameTextElements = nameTextElements[nameTextElements.length - 1];
    if(lastNameTextElements) {
        lastNameTextElements.classList.remove("flowing-text");
    }

    const messageTextElements = document.querySelectorAll("#chat-messages .message-text");
    const lastMessageTextElement = messageTextElements[messageTextElements.length - 1];
    if(lastMessageTextElement) {
        let html = convertTextToHtmlWithMarkdown(content);
        html = escapeTex(html);
        html = adjustURL(html);
        html = marked.parse(html);
        html = unescapeTex(html);
        lastMessageTextElement.innerHTML = html;
        lastMessageTextElement.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
        });
        addTargetBlank(lastMessageTextElement);
        addCopyToClipboardButton(lastMessageTextElement);
    }

    MathJax.typesetPromise();
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ãƒãƒ£ãƒƒãƒˆå¿œç­”ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸ
function handleChatException(message) {
    alert(message);
    endResponse();
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ãƒãƒ£ãƒƒãƒˆå¿œç­”ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸ
async function handleChatTimeoutException(message) {
    if (confirm(`${message}\n` + getTextResource("retryConfirm"))) {
        const messageTextElements = document.querySelectorAll("#chat-messages .message-text");
        const lastMessageTextElement = messageTextElements[messageTextElements.length - 1];
        if (lastMessageTextElement) {
            lastMessageTextElement.textContent = "";
        }

        // Pythonå´ã«é€šçŸ¥
        try {
            await pywebview.api.retry_send_message_to_chatgpt();
        }
        catch (error) {
            console.error("Error: " + error)
        }
    }
    else {
        endResponse()
    }
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ãƒãƒ£ãƒƒãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†è¨­å®šã™ã‚‹
function setChatMessages(messages) {
    console.log(messages);
    document.getElementById("chat-messages").innerHTML = "";
    for (let message of messages) {
        let speakerName = "";
        let speakerColor = "";
        if (message.role === "assistant") {
            speakerName = g_assistantName;
            speakerColor = g_assistantColor;
        }
        else {
            speakerName = g_userName;
            speakerColor = g_userColor;
        }
        addChatMessage(message.role, speakerName, speakerColor, message.content);
    }
    MathJax.typesetPromise();
    scrollToBottom();
    showChatRetryButton();
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç§»å‹•ã™ã‚‹
function moveToMessageAt(messageIndex, highlightText) {
    const element = document.getElementById(`message-${messageIndex}`);
    if (element) {
        element.scrollIntoView({ behavior: "smooth" });
        var instance = new Mark(document.body);
        instance.mark(highlightText);
    }
}

// å†å›ç­”ãƒœã‚¿ãƒ³ã‚’ã™ã¹ã¦éè¡¨ç¤ºã«ã™ã‚‹
function hideChatRetryButton() {
    const buttons = document.querySelectorAll(".chat-reanswer-btn");
    buttons.forEach((button, index) => {
        button.style.display = "none";
    });    
}

// æœ€å¾Œã®å†å›ç­”ãƒœã‚¿ãƒ³ã ã‘è¡¨ç¤ºã™ã‚‹
function showChatRetryButton() {
    const buttons = document.querySelectorAll(".chat-reanswer-btn");
    buttons.forEach((button, index) => {
        if (index === buttons.length - 1) {
            button.style.display = "inline";
        }
    });
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ãƒªãƒ—ãƒ¬ã‚¤æ©Ÿèƒ½ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯é–‹å§‹
function startReplayMessageBlock(role) {
    if (role === "assistant") {
        addChatMessage("replay_assistant", g_assistantName, g_assistantColor, "")
    }
    else {
        addChatMessage("replay_user", g_userName, g_userColor, "")
    }
    scrollToBottom();
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ãƒªãƒ—ãƒ¬ã‚¤æ©Ÿèƒ½ï¼šæ–‡ç« è¿½åŠ 
function addReplayMessage(text) {
    const messageTextElements = document.querySelectorAll("#chat-messages .message-text");
    const lastMessageTextElement = messageTextElements[messageTextElements.length - 1];
    if(lastMessageTextElement) {
        lastMessageTextElement.innerHTML += escapeHtml(text);
        scrollToBottom();
    }
}

// Pythonã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
// ãƒªãƒ—ãƒ¬ã‚¤æ©Ÿèƒ½ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯çµ‚äº†
function endReplayMessageBlock(content) {
    const messageTextElements = document.querySelectorAll("#chat-messages .message-text");
    const lastMessageTextElement = messageTextElements[messageTextElements.length - 1];
    if(lastMessageTextElement) {
        let html = convertTextToHtmlWithMarkdown(content);
        html = escapeTex(html);
        html = adjustURL(html);
        html = marked.parse(html);
        html = unescapeTex(html);
        lastMessageTextElement.innerHTML = html;
        lastMessageTextElement.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
        });
        addTargetBlank(lastMessageTextElement);
    }
    MathJax.typesetPromise();
}

// å‡¦ç†ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
function showProgressModal(message) {
    const modal = document.getElementById("progress-modal");
    const messageEl = document.getElementById("progress-modal-message");
    messageEl.textContent = message;
    modal.style.display = "block";
}

// å‡¦ç†ä¸­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
function hideProgressModal() {
    const modal = document.getElementById("progress-modal");
    modal.style.display = "none";
}
</script>

</body>
</html>
