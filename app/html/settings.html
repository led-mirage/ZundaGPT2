<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ZundaGPT2</title>
<link rel="stylesheet" href="css/style.css">
<style>
table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
}
th, td {
    border: 1px solid black;
    padding: 0.5rem;
    text-align: left;
    font-size: 0.9rem;
}
thead {
    background-color: #f2f2f2;
}
th {
    background-color: lightskyblue;
}
th:nth-child(1), th:nth-child(2), td:nth-child(1), td:nth-child(2) {
    width: 1%;
    white-space: nowrap;
}
td:nth-child(1) {
    text-align: center;
    background-color:#faf3e7;
    cursor: pointer;
}
th:nth-child(3), td:nth-child(3) {
    width: auto;
}
.remark {
    color: gray;
    font-size: 0.7rem;
}
a {
    color: royalblue;
    text-decoration: underline;
}
</style>
<script src="js/textResources.js" defer></script>
</head>
<body>
<div class="chat-container">
  <div class="header">
    <span id="title">è¨­å®šåˆ‡æ›¿</span>
    <nav>
      <ul>
        <li><button onclick="refresh()">ğŸ”„ï¸</button></li>
        <li><button onclick="cancel()">cancel</button></li>
        <li><button onclick="submit()">ok</button></li>
      </ul>
    </nav>
  </div>
  <div id="chat-messages" class="chat-messages">
    <table id="jsonTable">
      <thead>
        <tr>
          <th id="column-select">é¸æŠ</th>
          <th id="column-display-name">è¡¨ç¤ºå</th>
          <th id="column-description">èª¬æ˜</th>
        </tr>
      </thead>
      <tbody>
      <!-- JavaScriptã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡ŒãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
      </tbody>
    </table>
  </div>
  <div style="height: 1em;"></div>
</div>
<footer><span id="copyright">Copyright</span></footer>

<script>
let g_selectedIndex = -1;
let g_settingFiles = null;

// åˆæœŸåŒ–
document.addEventListener("DOMContentLoaded", function() {
    initUIComponents();
});

// pywebviewã®åˆæœŸåŒ–å®Œäº†
window.addEventListener("pywebviewready", async function() {
    // Pythonå´ã«é€šçŸ¥
    try {
        copyright = await pywebview.api.get_copyright();
        footer = document.getElementById("copyright");
        if (footer) {
            footer.textContent = copyright;
        }

        g_settingFiles = await pywebview.api.get_settings_files();
        create_table(g_settingFiles);

        elm = document.querySelector('.selectable[data-index="' + g_selectedIndex + '"]');
        elm.scrollIntoView({ behavior: 'smooth' });
    }
    catch (error) {
        console.error("Error: " + error)
    }
})

// UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆæœŸåŒ–
function initUIComponents() {
    let elm = document.getElementById("title");
    if (elm) {
        elm.textContent = getTextResource("settingsTitle");
    }

    elm = document.getElementById("column-select");
    if (elm) {
        elm.textContent = getTextResource("settingsColumnSelect");
    }

    elm = document.getElementById("column-display-name");
    if (elm) {
        elm.textContent = getTextResource("settingsColumnDisplayName");
    }

    elm = document.getElementById("column-description");
    if (elm) {
        elm.textContent = getTextResource("settingsColumnDescription");
    }
}

// è¨­å®šè¡¨ã®ä½œæˆ
function create_table(settingsFiles) {
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®tbodyè¦ç´ ã‚’å–å¾—
    const tableBody = document.getElementById("jsonTable").getElementsByTagName("tbody")[0];
    tableBody.innerHTML = "";

    // JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã‚’ç”Ÿæˆ
    settingsFiles.forEach((item, index) => {
        // æ–°ã—ã„è¡Œã¨ã‚»ãƒ«ã‚’ä½œæˆ
        let newRow = tableBody.insertRow();
        let cell1 = newRow.insertCell(0);
        let cell2 = newRow.insertCell(1);
        let cell3 = newRow.insertCell(2);

        // ã‚»ãƒ«ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
        cell1.textContent = item.current ? "âœ…" : "";

        filename = escapeHtml(item.filename);
        displayName = escapeHtml(item.displayName);
        description = escapeHtml(item.description);
        userName = escapeHtml(item.userName);
        assistantName = escapeHtml(item.assistantName);
        api = escapeHtml(item.api);
        model = escapeHtml(item.model);

        cell2.innerHTML = `${displayName}<br><span class="remark">${assistantName} x ${userName}</span>`;
        cell3.innerHTML = `${description}<br><span class="remark">${api}ã€€${model}ã€€<a href="javascript:void(0);" onclick="edit(${index});">${filename}</a></span>`;

        if (item.current)
            g_selectedIndex = index;

        cell1.classList.add('selectable');
        cell1.setAttribute('data-index', index);
    });

    // é¸æŠãƒãƒ¼ã‚¯ã®ç§»å‹•æ©Ÿèƒ½
    document.querySelectorAll('.selectable').forEach(cell => {
        cell.addEventListener('click', function() {
            if (g_selectedIndex != -1) {
                elm = document.querySelector('.selectable[data-index="' + g_selectedIndex + '"]')
                elm.textContent = "";
            }
            this.textContent = "âœ…"; // æ–°ã—ã„é¸æŠã‚’è¨­å®š
            g_selectedIndex = this.getAttribute('data-index');
        });
    });
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
async function refresh() {
    // Pythonå´ã«é€šçŸ¥
    try {
        g_settingFiles = await pywebview.api.get_settings_files();
        create_table(g_settingFiles);
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ç·¨é›†ãƒªãƒ³ã‚¯æŠ¼ä¸‹ã‚¤ãƒ™ãƒ³ãƒˆ
async function edit(index) {
    // Pythonå´ã«é€šçŸ¥
    try {
        selectedFile = g_settingFiles[index].filename;
        await pywebview.api.edit_settings(selectedFile);
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// OKãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‚¤ãƒ™ãƒ³ãƒˆ
async function submit() {
    // Pythonå´ã«é€šçŸ¥
    try {
        selectedFile = g_settingFiles[g_selectedIndex].filename;
        await pywebview.api.submit_settings(selectedFile);
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‚¤ãƒ™ãƒ³ãƒˆ
async function cancel() {
    // Pythonå´ã«é€šçŸ¥
    try {
        await pywebview.api.cancel_settings();
    }
    catch (error) {
        console.error("Error: " + error)
    }
}

// æ–‡å­—åˆ—ã‚’HTMLç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
function escapeHtml(text) {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#x27;")
        .replace(/\n/g, "<br>")
        .replace(/ /g, "&nbsp;")
        .replace(/\t/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
}
</script>

</body>
</html>
